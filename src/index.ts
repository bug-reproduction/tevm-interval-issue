import {createMemoryClient, MemoryClient} from '@tevm/memory-client';
import {EIP1193ProviderWithoutEvents, extendProviderWithAccounts} from 'eip-1193-accounts-wrapper';
import {setupEnvironment} from '@rocketh/web';
import {config, extensions} from 'template-ethereum-contracts/rocketh/config.js';
import DeployScript from 'template-ethereum-contracts/deploy/001_deploy_greetings_registry.js';
import {mnemonicToAccount, privateKeyToAccount} from 'viem/accounts';
import {createPublicClient, createWalletClient, custom, defineChain} from 'viem';
import {createCurriedJSONRPC} from 'remote-procedure-call';

async function main() {
	const USE_TEVM = true;

	const client = USE_TEVM
		? createMemoryClient({
				miningConfig: {
					type: 'auto',
				},
				// loggingLevel: 'debug',
			})
		: createCurriedJSONRPC('http://localhost:8545');

	let provider: EIP1193ProviderWithoutEvents = client as any;

	provider = ((p) => {
		return {
			// fix tevm not supporting "earliest"
			async request(args: {method: string; params?: any[]}) {
				if (args.method == 'eth_getBlockByNumber' && args.params?.[0] === 'earliest') {
					return p.request({
						method: 'eth_getBlockByNumber',
						params: ['0x0', args?.params[1]] as any,
					});
				}

				if (args.method == 'eth_estimateGas') {
					console.log(`eth_estimateGas`, args.params);
					const result = await p.request({
						method: 'eth_estimateGas',
						params: args.params as any,
					});
					console.log({result: BigInt(result)});

					return result;
				}

				if (args.method == 'eth_gasPrice') {
					return `0x${BigInt(100000000000).toString(16)}`;
				}

				return p.request(args as any);
			},
		} as any;
	})(provider);

	provider = extendProviderWithAccounts(provider as any, {
		accounts: {
			mnemonic: 'test test test test test test test test test test test junk',
		},
	});

	console.log(`send fund from account 1`);
	await provider.request({
		method: 'eth_sendRawTransaction',
		params: [
			'0x02f87382038480843b9aca008483215600825209943fab184622dc19b6109349b94811493bf2a45362872386f26fc1000080c080a0b7c93f4fac496e24a613e85539c197e47b6ccbc3118a9257676ac543910e883ca079620bbe9c09fd7c343d305968621867d99c688d61f995cfea9e34da3f83bc61',
		],
	});

	console.log(`create factory`);
	await provider.request({
		method: 'eth_sendRawTransaction',
		params: [
			'0xf8a58085174876e800830186a08080b853604580600e600039806000f350fe7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe03601600081602082378035828234f58015156039578182fd5b8082525050506014600cf31ba02222222222222222222222222222222222222222222222222222222222222222a02222222222222222222222222222222222222222222222222222222222222222',
		],
	});

	console.log(`using account 0 now...`);
	console.log(`deploy GreetingsRegistry_Implementation (deterministicly)`);

	const deployTxHash = await provider.request({
		method: 'eth_sendTransaction',
		params: [
			{
				from: '0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266',
				to: '0x4e59b44847b379578588920ca78fbf26c0b4956c', // factory
				// gas: `0x${(5000000).toString(16)}`,
				data: `0x0000000000000000000000000000000000000000000000000000000000000000608060405234801561000f575f5ffd5b50604051610c8c380380610c8c83398181016040528101906100319190610193565b805f908161003f91906103ea565b50506104b9565b5f604051905090565b5f5ffd5b5f5ffd5b5f5ffd5b5f5ffd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b6100a58261005f565b810181811067ffffffffffffffff821117156100c4576100c361006f565b5b80604052505050565b5f6100d6610046565b90506100e2828261009c565b919050565b5f67ffffffffffffffff8211156101015761010061006f565b5b61010a8261005f565b9050602081019050919050565b8281835e5f83830152505050565b5f610137610132846100e7565b6100cd565b9050828152602081018484840111156101535761015261005b565b5b61015e848285610117565b509392505050565b5f82601f83011261017a57610179610057565b5b815161018a848260208601610125565b91505092915050565b5f602082840312156101a8576101a761004f565b5b5f82015167ffffffffffffffff8111156101c5576101c4610053565b5b6101d184828501610166565b91505092915050565b5f81519050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f600282049050600182168061022857607f821691505b60208210810361023b5761023a6101e4565b5b50919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f6008830261029d7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610262565b6102a78683610262565b95508019841693508086168417925050509392505050565b5f819050919050565b5f819050919050565b5f6102eb6102e66102e1846102bf565b6102c8565b6102bf565b9050919050565b5f819050919050565b610304836102d1565b610318610310826102f2565b84845461026e565b825550505050565b5f5f905090565b61032f610320565b61033a8184846102fb565b505050565b5b8181101561035d576103525f82610327565b600181019050610340565b5050565b601f8211156103a25761037381610241565b61037c84610253565b8101602085101561038b578190505b61039f61039785610253565b83018261033f565b50505b505050565b5f82821c905092915050565b5f6103c25f19846008026103a7565b1980831691505092915050565b5f6103da83836103b3565b9150826002028217905092915050565b6103f3826101da565b67ffffffffffffffff81111561040c5761040b61006f565b5b6104168254610211565b610421828285610361565b5f60209050601f831160018114610452575f8415610440578287015190505b61044a85826103cf565b8655506104b1565b601f19841661046086610241565b5f5b8281101561048757848901518255600182019150602085019450602081019050610462565b868310156104a457848901516104a0601f8916826103b3565b8355505b6001600288020188555050505b505050505050565b6107c6806104c65f395ff3fe608060405234801561000f575f5ffd5b5060043610610034575f3560e01c8063368b8772146100385780635fdd59f814610054575b5f5ffd5b610052600480360381019061004d919061024d565b610084565b005b61006e600480360381019061006991906102f2565b610149565b60405161007b919061038d565b60405180910390f35b5f5f838360405160200161009a939291906104d8565b60405160208183030381529060405290508060015f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2090816100f591906106c1565b503373ffffffffffffffffffffffffffffffffffffffff167f5de788bae851e5b8df641f15cc3e7e401946111d99b835b0e3f619b04f8ce68f8260405161013c919061038d565b60405180910390a2505050565b6001602052805f5260405f205f915090508054610165906103da565b80601f0160208091040260200160405190810160405280929190818152602001828054610191906103da565b80156101dc5780601f106101b3576101008083540402835291602001916101dc565b820191905f5260205f20905b8154815290600101906020018083116101bf57829003601f168201915b505050505081565b5f5ffd5b5f5ffd5b5f5ffd5b5f5ffd5b5f5ffd5b5f5f83601f84011261020d5761020c6101ec565b5b8235905067ffffffffffffffff81111561022a576102296101f0565b5b602083019150836001820283011115610246576102456101f4565b5b9250929050565b5f5f60208385031215610263576102626101e4565b5b5f83013567ffffffffffffffff8111156102805761027f6101e8565b5b61028c858286016101f8565b92509250509250929050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6102c182610298565b9050919050565b6102d1816102b7565b81146102db575f5ffd5b50565b5f813590506102ec816102c8565b92915050565b5f60208284031215610307576103066101e4565b5b5f610314848285016102de565b91505092915050565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f61035f8261031d565b6103698185610327565b9350610379818560208601610337565b61038281610345565b840191505092915050565b5f6020820190508181035f8301526103a58184610355565b905092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f60028204905060018216806103f157607f821691505b602082108103610404576104036103ad565b5b50919050565b5f81905092915050565b5f819050815f5260205f209050919050565b5f8154610432816103da565b61043c818661040a565b9450600182165f8114610456576001811461046b5761049d565b60ff198316865281151582028601935061049d565b61047485610414565b5f5b8381101561049557815481890152600182019150602081019050610476565b838801955050505b50505092915050565b828183375f83830152505050565b5f6104bf838561040a565b93506104cc8385846104a6565b82840190509392505050565b5f6104e38286610426565b91506104f08284866104b4565b9150819050949350505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b5f6020601f8301049050919050565b5f82821b905092915050565b5f600883026105747fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610539565b61057e8683610539565b95508019841693508086168417925050509392505050565b5f819050919050565b5f819050919050565b5f6105c26105bd6105b884610596565b61059f565b610596565b9050919050565b5f819050919050565b6105db836105a8565b6105ef6105e7826105c9565b848454610545565b825550505050565b5f5f905090565b6106066105f7565b6106118184846105d2565b505050565b5b81811015610634576106295f826105fe565b600181019050610617565b5050565b601f8211156106795761064a81610414565b6106538461052a565b81016020851015610662578190505b61067661066e8561052a565b830182610616565b50505b505050565b5f82821c905092915050565b5f6106995f198460080261067e565b1980831691505092915050565b5f6106b1838361068a565b9150826002028217905092915050565b6106ca8261031d565b67ffffffffffffffff8111156106e3576106e26104fd565b5b6106ed82546103da565b6106f8828285610638565b5f60209050601f831160018114610729575f8415610717578287015190505b61072185826106a6565b865550610788565b601f19841661073786610414565b5f5b8281101561075e57848901518255600182019150602085019450602081019050610739565b8683101561077b5784890151610777601f89168261068a565b8355505b6001600288020188555050505b50505050505056fea26469706673582212200eb4d4bcb8ef9988de81c15629a8f830247471a5f0ef50f3ae14fd6e500176fb64736f6c634300081c00330000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000670726f78793a0000000000000000000000000000000000000000000000000000`,
			},
		],
	});

	const deployReceipt = await provider.request({
		method: 'eth_getTransactionReceipt',
		params: [deployTxHash],
	});

	console.log(deployReceipt);

	const codeAtAddress = await provider.request({
		method: 'eth_getCode',
		params: ['0x764db1221c377f8bb693481a1f722330711211fb'],
	});

	console.log(codeAtAddress);
}

main();
