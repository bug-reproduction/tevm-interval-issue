import {createMemoryClient} from '@tevm/memory-client';
import {EIP1193ProviderWithoutEvents, extendProviderWithAccounts} from 'eip-1193-accounts-wrapper';
import {setupEnvironment} from '@rocketh/web';
import {config, extensions} from 'template-ethereum-contracts/rocketh/config.js';
import DeployScript from 'template-ethereum-contracts/deploy/001_deploy_greetings_registry.js';
import {mnemonicToAccount, privateKeyToAccount} from 'viem/accounts';
import {createPublicClient, createWalletClient, custom, defineChain} from 'viem';
import {createCurriedJSONRPC} from 'remote-procedure-call';

async function main() {
	const client = createMemoryClient({
		miningConfig: {
			type: 'auto',
		},
		// loggingLevel: 'debug',
	});
	// const client = createCurriedJSONRPC('http://localhost:8545');

	let provider: EIP1193ProviderWithoutEvents = client as any;
	provider = ((p) => {
		return {
			// fix tevm not supporting "earliest"
			async request(args: {method: string; params?: any[]}) {
				if (args.method == 'eth_sendRawTransaction' || args.method == 'eth_call') {
					console.log(`calling ${args.method}...`, args.params);
				}

				if (args.method == 'eth_getBlockByNumber' && args.params?.[0] === 'earliest') {
					return p.request({
						method: 'eth_getBlockByNumber',
						params: ['0x0', args?.params[1]] as any,
					});
				}

				return p.request(args as any);
			},
		} as any;
	})(provider);

	provider = extendProviderWithAccounts(provider as any, {
		accounts: {
			mnemonic: 'test test test test test test test test test test test junk',
		},
	});

	// const {loadAndExecuteDeploymentsFromModules} = setupEnvironment(config, extensions);
	// await loadAndExecuteDeploymentsFromModules([{id: 'DeployScript', module: DeployScript}], {
	// 	provider: provider,
	// 	environment: 'tevm',
	// 	logLevel: 7,
	// });

	// process.exit();

	console.log(`send fund`);
	await provider.request({
		method: 'eth_sendRawTransaction',
		params: [
			'0x02f87382038480843b9aca008483215600825208943fab184622dc19b6109349b94811493bf2a45362872386f26fc1000080c080a0e613d193045626ff9442f36f03e09a314163d657075cc9e9c576e7f425ffabffa05eb002716d041bc70811de83bd6f974568d3ffb78bd3b4474c523a2d33fec1bb',
		],
	});

	console.log(`create factory`);
	await provider.request({
		method: 'eth_sendRawTransaction',
		params: [
			'0xf8a58085174876e800830186a08080b853604580600e600039806000f350fe7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe03601600081602082378035828234f58015156039578182fd5b8082525050506014600cf31ba02222222222222222222222222222222222222222222222222222222222222222a02222222222222222222222222222222222222222222222222222222222222222',
		],
	});

	console.log(`deploy GreetingsRegistry_Implementation (deterministicly)`);
	await provider.request({
		method: 'eth_sendRawTransaction',
		params: [
			'0x02f90d7b82038401843b9aca008472609af6830823ac944e59b44847b379578588920ca78fbf26c0b4956c80b90d0c0000000000000000000000000000000000000000000000000000000000000000608060405234801561000f575f5ffd5b50604051610c8c380380610c8c83398181016040528101906100319190610193565b805f908161003f91906103ea565b50506104b9565b5f604051905090565b5f5ffd5b5f5ffd5b5f5ffd5b5f5ffd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b6100a58261005f565b810181811067ffffffffffffffff821117156100c4576100c361006f565b5b80604052505050565b5f6100d6610046565b90506100e2828261009c565b919050565b5f67ffffffffffffffff8211156101015761010061006f565b5b61010a8261005f565b9050602081019050919050565b8281835e5f83830152505050565b5f610137610132846100e7565b6100cd565b9050828152602081018484840111156101535761015261005b565b5b61015e848285610117565b509392505050565b5f82601f83011261017a57610179610057565b5b815161018a848260208601610125565b91505092915050565b5f602082840312156101a8576101a761004f565b5b5f82015167ffffffffffffffff8111156101c5576101c4610053565b5b6101d184828501610166565b91505092915050565b5f81519050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f600282049050600182168061022857607f821691505b60208210810361023b5761023a6101e4565b5b50919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f6008830261029d7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610262565b6102a78683610262565b95508019841693508086168417925050509392505050565b5f819050919050565b5f819050919050565b5f6102eb6102e66102e1846102bf565b6102c8565b6102bf565b9050919050565b5f819050919050565b610304836102d1565b610318610310826102f2565b84845461026e565b825550505050565b5f5f905090565b61032f610320565b61033a8184846102fb565b505050565b5b8181101561035d576103525f82610327565b600181019050610340565b5050565b601f8211156103a25761037381610241565b61037c84610253565b8101602085101561038b578190505b61039f61039785610253565b83018261033f565b50505b505050565b5f82821c905092915050565b5f6103c25f19846008026103a7565b1980831691505092915050565b5f6103da83836103b3565b9150826002028217905092915050565b6103f3826101da565b67ffffffffffffffff81111561040c5761040b61006f565b5b6104168254610211565b610421828285610361565b5f60209050601f831160018114610452575f8415610440578287015190505b61044a85826103cf565b8655506104b1565b601f19841661046086610241565b5f5b8281101561048757848901518255600182019150602085019450602081019050610462565b868310156104a457848901516104a0601f8916826103b3565b8355505b6001600288020188555050505b505050505050565b6107c6806104c65f395ff3fe608060405234801561000f575f5ffd5b5060043610610034575f3560e01c8063368b8772146100385780635fdd59f814610054575b5f5ffd5b610052600480360381019061004d919061024d565b610084565b005b61006e600480360381019061006991906102f2565b610149565b60405161007b919061038d565b60405180910390f35b5f5f838360405160200161009a939291906104d8565b60405160208183030381529060405290508060015f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2090816100f591906106c1565b503373ffffffffffffffffffffffffffffffffffffffff167f5de788bae851e5b8df641f15cc3e7e401946111d99b835b0e3f619b04f8ce68f8260405161013c919061038d565b60405180910390a2505050565b6001602052805f5260405f205f915090508054610165906103da565b80601f0160208091040260200160405190810160405280929190818152602001828054610191906103da565b80156101dc5780601f106101b3576101008083540402835291602001916101dc565b820191905f5260205f20905b8154815290600101906020018083116101bf57829003601f168201915b505050505081565b5f5ffd5b5f5ffd5b5f5ffd5b5f5ffd5b5f5ffd5b5f5f83601f84011261020d5761020c6101ec565b5b8235905067ffffffffffffffff81111561022a576102296101f0565b5b602083019150836001820283011115610246576102456101f4565b5b9250929050565b5f5f60208385031215610263576102626101e4565b5b5f83013567ffffffffffffffff8111156102805761027f6101e8565b5b61028c858286016101f8565b92509250509250929050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6102c182610298565b9050919050565b6102d1816102b7565b81146102db575f5ffd5b50565b5f813590506102ec816102c8565b92915050565b5f60208284031215610307576103066101e4565b5b5f610314848285016102de565b91505092915050565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f61035f8261031d565b6103698185610327565b9350610379818560208601610337565b61038281610345565b840191505092915050565b5f6020820190508181035f8301526103a58184610355565b905092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f60028204905060018216806103f157607f821691505b602082108103610404576104036103ad565b5b50919050565b5f81905092915050565b5f819050815f5260205f209050919050565b5f8154610432816103da565b61043c818661040a565b9450600182165f8114610456576001811461046b5761049d565b60ff198316865281151582028601935061049d565b61047485610414565b5f5b8381101561049557815481890152600182019150602081019050610476565b838801955050505b50505092915050565b828183375f83830152505050565b5f6104bf838561040a565b93506104cc8385846104a6565b82840190509392505050565b5f6104e38286610426565b91506104f08284866104b4565b9150819050949350505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b5f6020601f8301049050919050565b5f82821b905092915050565b5f600883026105747fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610539565b61057e8683610539565b95508019841693508086168417925050509392505050565b5f819050919050565b5f819050919050565b5f6105c26105bd6105b884610596565b61059f565b610596565b9050919050565b5f819050919050565b6105db836105a8565b6105ef6105e7826105c9565b848454610545565b825550505050565b5f5f905090565b6106066105f7565b6106118184846105d2565b505050565b5b81811015610634576106295f826105fe565b600181019050610617565b5050565b601f8211156106795761064a81610414565b6106538461052a565b81016020851015610662578190505b61067661066e8561052a565b830182610616565b50505b505050565b5f82821c905092915050565b5f6106995f198460080261067e565b1980831691505092915050565b5f6106b1838361068a565b9150826002028217905092915050565b6106ca8261031d565b67ffffffffffffffff8111156106e3576106e26104fd565b5b6106ed82546103da565b6106f8828285610638565b5f60209050601f831160018114610729575f8415610717578287015190505b61072185826106a6565b865550610788565b601f19841661073786610414565b5f5b8281101561075e57848901518255600182019150602085019450602081019050610739565b8683101561077b5784890151610777601f89168261068a565b8355505b6001600288020188555050505b50505050505056fea26469706673582212200eb4d4bcb8ef9988de81c15629a8f830247471a5f0ef50f3ae14fd6e500176fb64736f6c634300081c00330000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000670726f78793a0000000000000000000000000000000000000000000000000000c001a0f1c7fb15d01e888928e381bb2a2a3cb1a6228afb25e65337086615cda9bc5039a03231d4843f30ea45eee11595e7b070144eff6f659fecff818da970a005fc69ac',
		],
	});

	console.log(`deploy GreetingsRegistry_Proxy`);
	const proxyTxHash = await provider.request({
		method: 'eth_sendRawTransaction',
		params: [
			'0x02f90da782038402843b9aca00846b8fd70a8309cc4d8080b90d4c608060405260405162000ccc38038062000ccc8339810160408190526200002691620001fc565b620000318262000046565b6200003d8382620000b8565b505050620002fa565b60006200006060008051602062000cac8339815191525490565b90508160008051602062000cac83398151915255816001600160a01b0316816001600160a01b03167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc8054908390556040516001600160a01b0380851691908316907f5570d70a002632a7b0b3c9304cc89efb62d8da9eca0dbd7752c83b737906829690600090a381511562000195576000836001600160a01b0316836040516200013c9190620002dc565b600060405180830381855af49150503d806000811462000179576040519150601f19603f3d011682016040523d82523d6000602084013e6200017e565b606091505b505090508062000193573d806000803e806000fd5b505b505050565b80516001600160a01b0381168114620001b257600080fd5b919050565b634e487b7160e01b600052604160045260246000fd5b60005b83811015620001ea578181015183820152602001620001d0565b83811115620001935750506000910152565b6000806000606084860312156200021257600080fd5b6200021d846200019a565b92506200022d602085016200019a565b60408501519092506001600160401b03808211156200024b57600080fd5b818601915086601f8301126200026057600080fd5b815181811115620002755762000275620001b7565b604051601f8201601f19908116603f01168101908382118183101715620002a057620002a0620001b7565b81604052828152896020848701011115620002ba57600080fd5b620002cd836020830160208801620001cd565b80955050505050509250925092565b60008251620002f0818460208701620001cd565b9190910192915050565b6109a2806200030a6000396000f3fe60806040526004361061005e5760003560e01c80634f1ef286116100435780634f1ef286146101295780638da5cb5b1461013c578063f2fde38b14610176576100ca565b806301ffc9a7146100d45780633659cfe614610109576100ca565b366100ca576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152600e60248201527f45544845525f52454a454354454400000000000000000000000000000000000060448201526064015b60405180910390fd5b6100d2610196565b005b3480156100e057600080fd5b506100f46100ef366004610806565b6101e1565b60405190151581526020015b60405180910390f35b34801561011557600080fd5b506100d2610124366004610871565b6103af565b6100d261013736600461088c565b610481565b34801561014857600080fd5b5061015161057c565b60405173ffffffffffffffffffffffffffffffffffffffff9091168152602001610100565b34801561018257600080fd5b506100d2610191366004610871565b6105ab565b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc5460003681823780813683855af491503d8082833e8280156101d7578183f35b8183fd5b50505050565b60007f01ffc9a7000000000000000000000000000000000000000000000000000000007fffffffff000000000000000000000000000000000000000000000000000000008316148061027457507f7f5828d0000000000000000000000000000000000000000000000000000000007fffffffff000000000000000000000000000000000000000000000000000000008316145b1561028157506001919050565b7fffffffff0000000000000000000000000000000000000000000000000000000080831614156102b357506000919050565b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc546040517f01ffc9a70000000000000000000000000000000000000000000000000000000081527fffffffff000000000000000000000000000000000000000000000000000000008416600482015273ffffffffffffffffffffffffffffffffffffffff8216906301ffc9a790602401602060405180830381865afa92505050801561039b575060408051601f3d9081017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe01682019092526103989181019061090f565b60015b6103a85750600092915050565b9392505050565b7fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61035473ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610465576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152600e60248201527f4e4f545f415554484f52495a454400000000000000000000000000000000000060448201526064016100c1565b61047e816040518060200160405280600081525061066a565b50565b7fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61035473ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610537576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152600e60248201527f4e4f545f415554484f52495a454400000000000000000000000000000000000060448201526064016100c1565b6105778383838080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525061066a92505050565b505050565b60006105a67fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61035490565b905090565b7fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61035473ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610661576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152600e60248201527f4e4f545f415554484f52495a454400000000000000000000000000000000000060448201526064016100c1565b61047e81610759565b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc80549083905560405173ffffffffffffffffffffffffffffffffffffffff80851691908316907f5570d70a002632a7b0b3c9304cc89efb62d8da9eca0dbd7752c83b737906829690600090a38151156105775760008373ffffffffffffffffffffffffffffffffffffffff16836040516107059190610931565b600060405180830381855af49150503d8060008114610740576040519150601f19603f3d011682016040523d82523d6000602084013e610745565b606091505b50509050806101db573d806000803e806000fd5b60006107837fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61035490565b9050817fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d6103558173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b60006020828403121561081857600080fd5b81357fffffffff00000000000000000000000000000000000000000000000000000000811681146103a857600080fd5b803573ffffffffffffffffffffffffffffffffffffffff8116811461086c57600080fd5b919050565b60006020828403121561088357600080fd5b6103a882610848565b6000806000604084860312156108a157600080fd5b6108aa84610848565b9250602084013567ffffffffffffffff808211156108c757600080fd5b818601915086601f8301126108db57600080fd5b8135818111156108ea57600080fd5b8760208285010111156108fc57600080fd5b6020830194508093505050509250925092565b60006020828403121561092157600080fd5b815180151581146103a857600080fd5b6000825160005b818110156109525760208186018101518583015201610938565b81811115610961576000828501525b50919091019291505056fea2646970667358221220e649c37c69d6249070369be01f33af3368fcdcea9814421a048306c2829c125964736f6c634300080a0033b53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d6103000000000000000000000000764db1221c377f8bb693481a1f722330711211fb0000000000000000000000008c8d35429f74ec245f8ef2f4fd1e551cff97d65000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000c080a0f8e4d5c795396e4e5ce54478746abb92417414de45fc989c8b058ce5d3f771afa07d221b0663ba11a3d8ff655f7ea8c5b418d748a40fcad96858f1230d8efb0dc6',
		],
	});

	const proxyReceipt = await provider.request({
		method: 'eth_getTransactionReceipt',
		params: [proxyTxHash],
	});
	console.log(proxyReceipt);

	console.log(`setting message: "hello"`);
	await provider.request({
		method: 'eth_sendRawTransaction',
		params: [
			'0x01f8cc82038403846ca716b182d7b4949fe46736679d2d9a65f0992f2272de9f3c7fa6e080b864368b87720000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000568656c6c6f000000000000000000000000000000000000000000000000000000c080a07397f219f520fb46152661cadbb9d32c8aad91f73f8ebf5a2da1a73701676abaa0528ca6e52349d008e2c0917ada47d2fd5b27bdcc652d94cb8093b755601a3403',
		],
	});

	console.log(`getting message`);

	const result = await provider.request({
		method: 'eth_call',
		params: [
			{
				data: '0x5fdd59f8000000000000000000000000f39fd6e51aad88f6f4ce6ab8827279cfffb92266',
				to: '0x9fe46736679d2d9a65f0992f2272de9f3c7fa6e0',
			},
			'pending',
		],
	});
	console.log(result);

	// testing missing methods in tevm:
	// const chainId = await provider.request({method: 'eth_chainId'});
	// const chain = defineChain({
	// 	id: Number(chainId),
	// 	name: 'test',
	// 	nativeCurrency: {symbol: 'ETH', decimals: 18, name: 'Ether'},
	// 	rpcUrls: {default: {http: []}},
	// });
	// const account = mnemonicToAccount('test test test test test test test test test test test junk');
	// const walletClient = createWalletClient({
	// 	account,
	// 	transport: custom(provider),
	// 	chain,
	// });
	// const publicClient = createPublicClient({
	// 	transport: custom(provider),
	// 	chain,
	// });
	// dummy that will trigger `eth_fillTransaction`
	// it will fails so it fallback on `eth_getTransactionCount...` + `eth_getBlockByNumber...` + `eth_maxPriorityFeePerGas` + `eth_estimateGas`
	// and since `eth_maxPriorityFeePerGas` fails it will also fallback on `eth_gasPrice...`
	// const txHash = await walletClient.sendTransaction({});
	// const receipt = await publicClient.waitForTransactionReceipt({
	// 	hash: txHash,
	// });
	// console.log(receipt);
}

main();
